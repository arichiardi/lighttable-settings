#!/bin/sh

set -e

tarsnap_bin=$(which tarsnap)
if [ -z "$tarsnap_bin" ]; then
    echo "Tarsnap is not installed, see https://www.tarsnap.com/download.html"
    exit 1
fi

tarsnap_conf=$HOME/.backup/tarsnap.conf
work_dir=/tmp
root_dir=vault

$tarsnap_bin --verify-config $tarsnap_conf

if [ "$1" = "--fsck" -o "$1" = "-f" -o "$1" = "--cache" ] ; then
    echo "Rebuilding tarsnap cache...";
    $tarsnap_bin --fsck --configfile "$tarsnap_conf"
else
    echo "Performing tarsnap backup...";
    $tarsnap_bin --configfile "$tarsnap_conf" \
             -C "$work_dir" \
             -c \
             -v \
             -f "$(uname -n)-$(date +%Y%m%d-%H%M%S)" \
             "$root_dir";
fi

cd -
