#!/bin/sh

set -e

mount_point=${1:-}

if [ -z "$mount_point" ]; then
    error_code=66
    echo "Please pass the mount point as first parameter (error: $error_code)"
    exit $error_code
fi

# convenience
rebuild_cache=${2:false}

TARSNAP=$(which tarsnap)
if [ -z "$TARSNAP" ]; then
    echo "Tarsnap is not installed, see https://www.tarsnap.com/download.html"
    exit 1
fi

CONF=$HOME/.backup/vault.tarsnap
ROOT_DIR=$mount_point

$TARSNAP --verify-config $CONF

if [ "$rebuild_cache" = "true" ] ; then
    echo "Rebuilding tarsnap cache...";
    sudo $TARSNAP --fsck --configfile "$CONF";
else
    echo "Performing tarsnap backup...";
    sudo $TARSNAP \
         --configfile "$CONF" \
         -c \
         -v \
         -f "$(uname -n)-$(date +%Y%m%d-%H%M%S)" \
         "$ROOT_DIR";
fi
