#!/bin/bash

set -uo pipefail

loop_file=${1:-}

if [ -z "$loop_file" ]; then
    error_code=65
    echo "Please pass the vault file path as first parameter (error: $error_code)"
    exit $error_code
fi

mount_point=${2:-}

if [ -z "$mount_point" ]; then
    error_code=66
    echo "Please pass the mount point as second parameter (error: $error_code)"
    exit $error_code
fi

dev_loop=""
existing_loop=$(losetup -j "$loop_file")

if [ -z "$existing_loop" ] ; then
    TMP_LOOP=$(sudo losetup -f)
    echo -e "Mounting vault on $dev_loop..."
    sudo losetup $TMP_LOOP $loop_file
    if [ "$?" = 0 ]; then
        dev_loop=$TMP_LOOP
    fi
else
    dev_loop=$(echo $existing_loop | awk -F":" '{ print($1) }')
    echo -e "The file $loop_file is already mounted on $dev_loop";
fi

if [ -n "$dev_loop" ]; then

    luks_status=$(sudo cryptsetup status vault)
    matches_count=$(echo "$luks_status" | grep -c 'read/write')

    if [ "$matches_count" -lt 1 ]; then

        sudo cryptsetup luksOpen $dev_loop vault

        if [ "$?" -eq 0 ]; then
            mkdir -p $mount_point
            sudo mount /dev/mapper/vault $mount_point

            if [ "$?" -eq 0 ]; then
                echo -e "Vault mounted on $mount_point"
            else
                echo -e "Error: mount exited with $?"
            fi

        else
            echo -e "Error: cryptsetup exited with $?"
        fi
    else
        echo "$luks_status"
    fi
else
    echo -e "Error: cannot detect the mounted loop device"
fi

exit $?
